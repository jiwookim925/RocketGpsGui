<!DOCTYPE html>
<html>
  <head>
    <title>ROCKET_GPS_GUI</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=geometry"></script>
    <style>
      #map { height: 100vh; width: 100%; }
      #connectBtn {
        position: absolute; top: 10px; left: 10px; z-index: 10;
        padding: 10px; background: white; border-radius: 8px;
        font-size: 16px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      }
    </style>
  </head>
  <body>5
    <button id="connectBtn">포트 연결</button>
    <div id="map"></div>

    <script>
      let map, myMarker, rocketMarker;
      let port, reader;

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 15,
          center: { lat: 37.0, lng: 127.0 }, // 초기 중심
        });

        myMarker = new google.maps.Marker({ map, label: "나" });
        rocketMarker = new google.maps.Marker({ map, label: "로켓" });

        // 내 위치 추적
        navigator.geolocation.watchPosition((pos) => {
          const myLatLng = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };
          myMarker.setPosition(myLatLng);
        });
      }

      async function connectSerial() {
        try {
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 9600 });

          const decoder = new TextDecoderStream();
          const inputDone = port.readable.pipeTo(decoder.writable);
          reader = decoder.readable.getReader();

          let buffer = "";
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) {
              buffer += value;
              let lines = buffer.split('\n');
              buffer = lines.pop(); // 마지막 줄은 아직 끝 안 났을 수 있음

              for (let line of lines) {
                handleGPSLine(line.trim());
              }
            }
          }
        } catch (err) {
          alert("포트 연결 실패: " + err);
        }
      }

      function parseNMEALatLng(rawLat, latDir, rawLng, lngDir) {
        const latDeg = parseFloat(rawLat.slice(0, 2));
        const latMin = parseFloat(rawLat.slice(2));
        const lngDeg = parseFloat(rawLng.slice(0, 3));
        const lngMin = parseFloat(rawLng.slice(3));
        let lat = latDeg + latMin / 60;
        let lng = lngDeg + lngMin / 60;
        if (latDir === 'S') lat *= -1;
        if (lngDir === 'W') lng *= -1;
        return { lat, lng };
      }

      function handleGPSLine(line) {
        if (line.startsWith('$GPRMC')) {
          const parts = line.split(',');
          if (parts[2] === 'A') { // 유효한 데이터인지 확인
            const { lat, lng } = parseNMEALatLng(parts[3], parts[4], parts[5], parts[6]);
            rocketMarker.setPosition({ lat, lng });

            if (myMarker.getPosition()) {
              const dist = google.maps.geometry.spherical.computeDistanceBetween(
                myMarker.getPosition(),
                rocketMarker.getPosition()
              );
              console.log("로켓까지 거리:", Math.round(dist), "m");
            }
          }
        }
      }

      document.getElementById("connectBtn").addEventListener("click", connectSerial);
      window.onload = initMap;
    </script>
  </body>
</html>
